# バックアップ・リカバリアプリケーション 要件定義書

## 1. プロジェクト概要

### 1.1 目的

開発環境のアプリケーション設定、パッケージマネージャー、エディタ拡張機能を一括でバックアップ・リストアするElectronベースのデスクトップアプリケーション。

### 1.2 対象OS

* Windows 11
* macOS
* Linux
* Windows環境ではWSLも考慮

### 1.3 主要機能

* アプリケーション設定ファイルのバックアップ・リストア
* パッケージマネージャーのインストール済みリストの管理
* VS Code系エディタの拡張機能管理（WSL内の拡張機能も含む）
* バックアップデータの一覧表示機能
* app_idごとの最終バックアップ日付管理

### 1.4 用語定義（表記統一）

* **app_id**：本アプリケーションにおける「リストア実行主体」の固有単位。
  例）winget / scoop / chocolatey / apt / homebrew / pacman / vscode / cursor / voideditor / git_config / npm_config 等
* **識別子**：パッケージマネージャーが管理する各アプリ（パッケージ）や、VS Code系エディタが管理する各拡張機能を指す呼称。本要件では **app_id とは区別** する。
  例）winget の `Microsoft.VisualStudioCode`、homebrew の `wget`、VS Code拡張 `ms-python.python` など
* **実行単位の原則**：1回のリストア実行につき **選択できる app_id は常に1つのみ**。選択された app_id 配下では **識別子（または拡張機能）を複数選択して順次処理** できる。

---

## 2. 機能要件

### 2.1 初回起動時の動作

* バックアップ先ディレクトリ選択画面を表示
* ディレクトリ選択後、メイン画面へ遷移
* **重要：** 起動時はファイルシステムに一切変更を加えない（読み取り専用動作）

### 2.2 検出機能

* インストール済みアプリケーション・パッケージマネージャーの自動検出
* 検出結果に基づいてUI上でEnable/Disable切り替え
* 存在しないアプリケーションはDisableで表示
* 各 **app_id** の最終バックアップ日付を表示
  ※パッケージマネージャー配下の各アプリは **識別子** として扱う

### 2.3 バックアップ機能

**実行方式：**

* すべての対象を纏めてバックアップ実行（一括）
* 個別選択してバックアップ実行（複数選択可能）
* バックアップ進捗を表示

**バックアップ内容：**

* パッケージマネージャー：インストール済み **識別子** リストをJSON形式で出力（各種情報を含む）
* VS Code系：拡張機能（= **識別子**）リストをテキスト形式で出力（WSL内も含む）
* 設定ファイル：ファイルコピー

**最終バックアップ日付：**

* **app_id** ごとに最終バックアップ日付を記録
* UI上で各 **app_id** の最終バックアップ日付を表示
* バックアップメタデータファイルに保存

### 2.4 一覧表示機能

* バックアップされたリスト系データ（パッケージ、拡張機能）の閲覧
* 人間が確認しやすい形式で表示
* フィルタリング・検索機能

**対象データ：**

* パッケージマネージャーのインストール済み **識別子** リスト
* VS Code系エディタの拡張機能（= **識別子**）リスト（WSL内の拡張機能も含む）

### 2.5 リストア機能

#### 実行単位（改定）

**基本原則：**

* リストアは **app_id 単位** で実行する
* **1回の実行で選択できる app_id は常に1つのみ（例外なし）**
* 選択した app_id 配下では、複数の **識別子**（または拡張機能）を選択して **1つずつ順次処理** できる

**禁止事項（例）：**

* × `winget + scoop + chocolatey` を順次（または同時）リストア
* × `vscode + cursor` を順次（または同時）リストア
* × `winget + vscode` を同時／順次リストア（カテゴリ混在も不可）

**許可例：**

* ○ `winget`（= app_id）を選択し、`wget`, `git`, `nodejs` など複数 **識別子** を順次リストア
* ○ `vscode`（= app_id）を選択し、`ms-python.python`, `esbenp.prettier-vscode` など複数拡張（= **識別子**）を順次リストア

#### パッケージマネージャー・VS Code系拡張機能のリストア

リストア時には以下の2つの選択肢を提供：

**方式A：すべてインストール**

* アプリケーションがコマンドを順次実行
* **重要：** 1つずつインストールコマンドを実行（一括復旧は行わない）
* **複数の識別子**（または拡張機能）を選択した場合は、1つ目→2つ目→...と順次処理
* インストール進捗表示
* エラーハンドリング
* 実行ログの保存

**方式B：インストールコマンドリスト出力**

* 実行可能なシェルスクリプト・PowerShellスクリプトを生成
* **複数の識別子**（または拡張機能）を選択した場合は、当該 app_id に対する全コマンドを **1つのスクリプト** に出力
* ユーザーが内容を確認・編集可能
* ユーザーが手動実行

#### 設定ファイルのリストア

設定ファイルは元の場所へファイル復元のみ。

**復元時の動作：**

* バックアップファイルを元のパスへコピー
* ファイルが既に存在する場合は上書き確認

  * はい：上書き
  * いいえ：スキップ
  * すべて：以降すべて上書き（確認なし）
* ディレクトリが存在しない場合は自動作成

---

## 3. 対象アプリケーション

### 3.1 パッケージマネージャー（個別処理）

**複数選択リストア：**

* **app_id の複数選択：不可**（1回の実行で選べる app_id は1つ）
* **識別子の複数選択：可能**（選択した app_id の配下で順次処理）

#### Windows

| ID（=app_id） | 名前              | コマンド                 | 検出方法               | バックアップ形式 |
| ----------- | --------------- | -------------------- | ------------------ | -------- |
| winget      | Winget          | `winget`             | `winget --version` | JSON     |
| scoop       | Scoop           | `scoop` (PowerShell) | `scoop --version`  | JSON     |
| chocolatey  | Chocolatey      | `choco`              | `choco --version`  | JSON     |
| msstore     | Microsoft Store | `winget`             | `winget --version` | JSON     |

#### macOS

| ID（=app_id） | 名前       | コマンド   | 検出方法             | バックアップ形式 |
| ----------- | -------- | ------ | ---------------- | -------- |
| homebrew    | Homebrew | `brew` | `brew --version` | JSON     |

#### Linux

| ID（=app_id） | 名前     | コマンド     | 検出方法               | バックアップ形式 |
| ----------- | ------ | -------- | ------------------ | -------- |
| apt         | APT    | `apt`    | `apt --version`    | JSON     |
| yum         | YUM    | `yum`    | `yum --version`    | JSON     |
| dnf         | DNF    | `dnf`    | `dnf --version`    | JSON     |
| pacman      | Pacman | `pacman` | `pacman --version` | JSON     |

**バックアップデータに含める情報：**

* **識別子** / 名前
* バージョン
* ソース/リポジトリ（該当する場合）
* その他各パッケージマネージャー固有の情報

**リストア方式：**

* すべて1つずつインストールコマンドを実行
* bundleやimportなどの一括復旧機能は使用しない
* エラー時に個別 **識別子** を特定できるようにする
* **app_id は単一選択。複数のパッケージマネージャーを同一実行で扱わない**

### 3.2 VS Code系エディタ（統合処理）

**複数選択リストア：**

* **app_id の複数選択：不可**（`vscode` / `cursor` / `voideditor` の同時・順次混在を禁止）
* **拡張機能（=識別子）の複数選択：可能**（選択した app_id に対して順次処理）

**処理方針：** 1つのプロセッサークラスで全エディタに対応。エディタタイプをパラメーターとして渡すことでコマンドを切り替え。

| エディタ        | ID（=app_id） | コマンド     | 拡張機能リスト取得                  | 拡張機能インストール                   | WSL拡張機能 |
| ----------- | ----------- | -------- | -------------------------- | ---------------------------- | ------- |
| VS Code     | vscode      | `code`   | `code --list-extensions`   | `code --install-extension`   | ✓       |
| Cursor      | cursor      | `cursor` | `cursor --list-extensions` | `cursor --install-extension` | ✓       |
| Void Editor | voideditor  | `void`   | `void --list-extensions`   | `void --install-extension`   | ✓       |

**WSL拡張機能の取得（Windowsのみ）：**

```bash
wsl -e code --list-extensions
wsl -e cursor --list-extensions
wsl -e void --list-extensions
```

#### 設定ファイルパス

| エディタ        | Windows                         | macOS                                       | Linux                   |
| ----------- | ------------------------------- | ------------------------------------------- | ----------------------- |
| VS Code     | `%APPDATA%\Code\User`           | `~/Library/Application Support/Code/User`   | `~/.config/Code/User`   |
| Cursor      | `%APPDATA%\Roaming\Cursor\User` | `~/Library/Application Support/Cursor/User` | `~/.config/Cursor/User` |
| Void Editor | `%APPDATA%\Void\User`           | `~/Library/Application Support/Void/User`   | `~/.config/Void/User`   |

**バックアップ対象ファイル：**

* `settings.json` - エディタ設定
* `keybindings.json` - キーバインド
* 拡張機能リスト（テキストファイル）
* WSL拡張機能リスト（別ファイル、Windows環境のみ）

**リストア方式：**

* **app_id は単一選択（例：vscode のみ）**
* 選択したエディタの拡張機能（= **識別子**）を1つずつインストール

### 3.3 アプリケーション設定ファイル（定義ベース処理）

**複数選択リストア：** 不可（1つの **app_id** のみ選択可能）

**処理方針：** 定義ファイルに追加するだけで新しいアプリケーションに対応。ファイルコピーのみの汎用ハンドラーで処理。複数のファイルはアプリケーション単位でグルーピング。

#### 開発ツール設定

| ID（=app_id） | 名前             | 対象OS          | ファイル数 | Windows パス                 | macOS パス       | Linux パス       |
| ----------- | -------------- | ------------- | ----- | -------------------------- | -------------- | -------------- |
| git_config  | Git グローバルコンフィグ | Win/Mac/Linux | 1     | `%USERPROFILE%\.gitconfig` | `~/.gitconfig` | `~/.gitconfig` |
| npm_config  | NPM コンフィグ      | Win/Mac/Linux | 1     | `%USERPROFILE%\.npmrc`     | `~/.npmrc`     | `~/.npmrc`     |
| pypi_config | PyPI コンフィグ     | Win/Mac/Linux | 1     | `%USERPROFILE%\.pypirc`    | `~/.pypirc`    | `~/.pypirc`    |

#### システム設定

| ID（=app_id）        | 名前                | 対象OS    | ファイル数 | Windows パス                                                            | macOS パス | Linux パス |
| ------------------ | ----------------- | ------- | ----- | --------------------------------------------------------------------- | -------- | -------- |
| wsl_config         | WSL コンフィグ         | Windows | 1     | `%USERPROFILE%\.wslconfig`                                            | -        | -        |
| powershell_profile | PowerShell プロファイル | Windows | 1     | `%USERPROFILE%\Documents\PowerShell\Microsoft.PowerShell_profile.ps1` | -        | -        |

#### アプリケーション設定

**Claude Desktop**

* ID（=app_id）: `claude_desktop`
* 対象OS: Windows / macOS / Linux
* ファイル数: 2
* Windows:

  * `%APPDATA%\Claude\claude_desktop_config.json`
  * `%APPDATA%\Claude\claude_desktop_config_disabled.json`
* macOS:

  * `~/Library/Application Support/Claude/claude_desktop_config.json`
  * `~/Library/Application Support/Claude/claude_desktop_config_disabled.json`
* Linux:

  * `~/.config/Claude/claude_desktop_config.json`
  * `~/.config/Claude/claude_desktop_config_disabled.json`

**Tabby Terminal**

* ID（=app_id）: `tabby`
* 対象OS: Windows / macOS / Linux
* ファイル数: 1
* Windows: `%APPDATA%\tabby\config.yaml`
* macOS: `~/Library/Application Support/tabby/config.yaml`
* Linux: `~/.config/tabby/config.yaml`

**FileZilla**

* ID（=app_id）: `filezilla`
* 対象OS: Windows / macOS / Linux
* ファイル数: 1
* Windows: `%APPDATA%\FileZilla\filezilla.xml`
* macOS: `~/.config/filezilla/filezilla.xml`
* Linux: `~/.config/filezilla/filezilla.xml`

**DbGate**

* ID（=app_id）: `dbgate`
* 対象OS: Windows / macOS / Linux
* ファイル数: 2
* Windows:

  * `%APPDATA%\dbgate\settings.json`
  * `%APPDATA%\dbgate\connections.jsonl`
* macOS:

  * `~/Library/Application Support/dbgate/settings.json`
  * `~/Library/Application Support/dbgate/connections.jsonl`
* Linux:

  * `~/.config/dbgate/settings.json`
  * `~/.config/dbgate/connections.jsonl`

**環境変数の解決：**

* Windows: `%USERPROFILE%`, `%APPDATA%`, `%LOCALAPPDATA%`
* macOS/Linux: `~`, `$HOME`

---

## 4. 処理の分類

### 4.1 個別処理（固有ロジック）

パッケージマネージャーとVS Code系エディタは専用プロセッサークラスで実装。

* 複雑なコマンド実行
* 出力パース処理
* JSON形式への変換
* プラットフォーム固有の処理
* WSL拡張機能の取得（VS Code系のみ）
* **識別子** の順次処理（**app_id は単一**）

**対象：**

* winget, scoop, chocolatey, msstore, homebrew, apt, yum, dnf, pacman
* VS Code系（vscode, cursor, voideditor）

### 4.2 定義ベース処理（汎用）

アプリケーション設定ファイルは定義ファイルへの追加のみで対応。複数ファイルをアプリケーション単位でグルーピング。

* ファイルの存在確認
* ファイルコピー
* パス解決
* 複数ファイルの一括処理
* 単一 **app_id** のみのリストア

**対象：**

* 開発ツール設定（Git, NPM, PyPI等）
* システム設定（WSL, PowerShell等）
* アプリケーション設定（Claude Desktop, Tabby, FileZilla, DbGate等）

---

## 5. 設計方針

### 5.1 処理の統合原則

**VS Code系の統合：**

* VS Code、Cursor、Void Editorは1つのプロセッサークラスで処理
* エディタタイプをパラメーターで渡してコマンドを切り替え
* コマンドの実行ファイル名のみが異なり、引数は共通
* WSL内の拡張機能も同様に処理（Windows環境のみ）
* **app_id は単一選択。複数エディタの同時・順次混在は不可**

**パッケージマネージャーの統合：**

* 各パッケージマネージャーは個別プロセッサーで実装
* バックアップ形式はすべてJSON形式に統一
* 各種情報（名前、バージョン、ソース等）を含める
* **app_id は単一選択。複数パッケージマネージャーの同時・順次混在は不可**

**設定ファイルの統合：**

* アプリケーション単位で複数ファイルをグルーピング
* OS別パス定義 + 共通処理ロジック
* 新しいアプリの追加は定義ファイルへの追記のみ
* 拡張性と保守性を重視
* リストアは単一 **app_id** のみ

### 5.2 安全性優先

**起動時の挙動：**

* 読み取り専用モード（変更を加えない）
* 検出のみ実行
* ユーザーの明示的な操作（バックアップ・リストアボタン）まで待機

**エラーハンドリング：**

* コマンド実行の失敗を適切に処理
* 部分的な失敗でも継続可能
* ユーザーへのフィードバック

**ファイル上書き時の確認：**

* 既存ファイルがある場合は必ず確認
* 選択肢：はい / いいえ / すべて

### 5.3 拡張性

**新規アプリケーション追加の容易さ：**

* 設定ファイル系：定義ファイルに追加するだけ
* 複数ファイルを持つアプリも定義で対応可能
* パッケージマネージャー系：新しいプロセッサークラスを作成してレジストリに登録
* OS対応：プラットフォーム判定による処理分岐

### 5.4 バックアップメタデータ管理

**最終バックアップ日付の記録：**

* **app_id** ごとに最終バックアップ日付を記録
* メタデータファイル（`backup_metadata.json`）に保存
* バックアップ実行時に自動更新

**メタデータファイル形式（例）：**

```json
{
  "winget": {
    "last_backup": "2025-10-07T10:30:00Z"
  },
  "vscode": {
    "last_backup": "2025-10-07T10:31:00Z"
  },
  "git_config": {
    "last_backup": "2025-10-07T10:32:00Z"
  }
}
```

---

## 6. バックアップデータ構造

### 6.1 ディレクトリ構造（例）

```
backup-directory/
├── backup_metadata.json
├── winget_packages.json
├── scoop_apps.json
├── chocolatey_packages.json
├── homebrew_packages.json
├── apt_packages.json
├── vscode_extensions.txt
├── vscode_extensions_wsl.txt
├── vscode_settings.json
├── vscode_keybindings.json
├── cursor_extensions.txt
├── cursor_extensions_wsl.txt
├── cursor_settings.json
├── void_extensions.txt
├── void_extensions_wsl.txt
├── void_settings.json
├── git_config_.gitconfig
├── npm_config_.npmrc
├── claude_desktop_claude_desktop_config.json
├── claude_desktop_claude_desktop_config_disabled.json
├── dbgate_settings.json
├── dbgate_connections.jsonl
├── tabby_config.yaml
└── ...
```

### 6.2 ファイル命名規則

すべてのバックアップファイルは以下の命名規則に従う：

**基本形式：** `{app_id}_{original_filename}`

* パッケージマネージャー：`{manager_id}_packages.json`
  例：`winget_packages.json`, `scoop_apps.json`, `homebrew_packages.json`
  （中身は **識別子** の集合）
* アプリケーション設定：`{app_id}_{original_filename}`
  例：`git_config_.gitconfig`, `vscode_settings.json`, `claude_desktop_claude_desktop_config.json`

**WSL内の設定ファイル：**
WSL内にも設定が存在するファイル（VS Code系の拡張機能など）は、ファイル名に `_wsl` を付与する。

* 例：`vscode_extensions_wsl.txt`, `cursor_extensions_wsl.txt`

**メタデータファイル：**

* `backup_metadata.json` - 各 **app_id** の最終バックアップ日付を記録
